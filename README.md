# DevOps Centerの運用について

このレポジトリでは、SalesforceのCI/CDとして運用可能なDevOps Centerに関する練習を記録する。

## 背景

この練習をやろうと考えたのには、以下のような背景がある

- ローコード開発者(以下、アドミ)の思い
  - アドミは、リリース作業を変更セットに頼らざるを得ない（CLIに不慣れ）
  - 変更セットの作成はブラウザが重くなり、リリースまでに必要な作業時間が増えがち
  - プログラマに片寄するためだけに、CLIやGit、Githubを覚えるのがつらい
- プログラマの思い
  - メタデータはGithubで管理したい
  - 変更セットを使いたくない
  - メタデータAPIをつかったリリースに頼りたいが、手動コマンド入力で本番にリリースするのは心理的な負担がある
  - メタデータAPIのデプロイは、間違った環境へリリースする危険が伴う
- 共通の思い
  - 最新のソースがなんなのか、把握できない（本番が正しいが、利用しているSandboxが最新のメタデータを保持しているのか判断がしにくい）
  - 設定値をexcelなどドキュメントに設計書として記載して、SF組織上で正しい値になっているのか、試験で確認するのが億劫（というか馬鹿馬鹿しくなってやってられない）
  - なるべくリリースに伴う手動の作業を減らしたい

↓

アドミ側とプログラマ側にはギャップがあるが、達成したい共通の目標もあることは確か。
そこで、Salesforce専用のCI/CDツールとして無料で利用できるDevOps CenterでCICDには、以下の利点があることがわかった。

- アドミには、なるべくGithubに対する学習コストを抑えられる
- 変更セットから脱却
- ソースコード管理可能
- プログラマは今まで通り、メタデータAPIを利用可能
- 無料で利用可能

そのため、軽くGUI開発とプログラム開発を実践してみて、実際のPJ導入イメージを作りたい。

---

### その他の選択肢

CI/CDツールで、以下があるが選択しなかった。

- Github Actions / CircleCI
  - テスト実行、リリースなどを完全自動化できるため、フルスクラッチなら必要不可欠なミドルウェア
  - アドミがメタデータAPIを使って開発資材を受信・gitでコミットしてGithubへpushするなど、Gitを理解するコストが増大するため、除外した
- [Flosum](https://devops.terrasky.co.jp/flosum)
  - 有料のAppExchangeであるため、検証する前にDevOps Centerを検証したほうがいいと考えた

---

## バージョン管理の前提方針

- × 全てのメタデータを管理する
- ⚪︎ デフォルト状態で作成した組織に対して、追加・変更されたメタデータのみ管理する

↓

ありとあらゆるメタデータを管理したい気持ちもあるが、ベストプラクティスは初期状態で作成したPJと比較したときの差分のみの管理を行う

## パイプライン構築

設定、開発の進め方は以下の記事がとても参考になった。

- [Salesforce DevOps Centerについてまとめてみた](https://qiita.com/arufian/items/675a61af6c765d1977db)

公式ガイドラインにもインストール手順が存在するため、従っていくと良い。

- [組織での DevOps センターの有効化とインストール](https://help.salesforce.com/s/articleView?id=platform.devops_center_setup_install.htm&type=5)
- [TrailHead | 変更セットに別れを告げて DevOps センターを使用する](https://trailhead.salesforce.com/ja/content/learn/modules/devops-center-quick-look/say-hello-to-devops-center)

---

### 設定は要約すると以下となる。

1. DevOps Centerの有効化
2. DevOps Centerパッケージインストール
3. 接続アプリケーションでDevOps Centerを設定
4. 権限セットを開発・リリースユーザーに割り当てる
5. アプリケーションを開き、Github組織と接続
6. Salesforce上でプロジェクト作成（このとき、既存のレポジトリか新規レポジトリか選択できる。完全新規PJであれば新規レポジトリで良いと考える）
7. リリース先となる環境（本番、ステージングなど）の環境を、パイプラインに指定

### 必要な権限セット

DevOps Centerに必要な権限セット一覧。DevOps Centerインストールと同時に自動で組織にインストールされる
[DevOps Center の権限セットを割り当てる](https://help.salesforce.com/s/articleView?id=platform.devops_center_assign_permsets.htm&type=5)

- 以下の2つを権限セットはでユーザーに割り当てると、アプリケーションランチャーでDevOps Centerがヒットするようになり、アクセスが容易になる
  - sf_devops_InitializeEnvironments
  - sf_devops_NamedCredentials
- ただし、権限セットグループ作成時、5つあるうち上記2つのみしたほうがよい。バグっぽいが、別の3つと混ぜた権限セットグループにすると、なぜかアプリケーションランチャーでDevOps Centerがヒットしなくなる(個別に5つ割り当てるとなぜかヒットする)

---

# パイプライン構築後

実際の開発手順は以下となる。組織を日本語設定しているため、案内は全て日本語である前提

## SalesforceのUI上でローコード開発するケース

1. DevOps Center > 作業項目 > 新しい作業項目
2. 作業内容を入力（Github IssuesのURLを貼る、でもよい）
3. 「接続された開発環境を使用して、DevOps Center から開発を行い、作業項目の機能ブランチへの変更を確定したいと考えています。」を選択し、自分の開発組織を選択し、「続行」をクリック。（自分の開発組織がなければ、「パイプライン > 環境」で、「開発環境を追加」をクリックして追加すること（追加権限がなければ、権限持ちユーザーに選択してもらう）
4. ブランチが発行される。ベースブランチは作業ブランチの上流ブランチである。
5. 開発環境でフローやカスタムオブジェクト、カスタム項目などを開発
6. 「変更を取り込み」もしくは「コンポーネントを手動で追加」を選択し、上流環境へ同期したいメタデータを選択リストから選択
7. コメント欄に、コミットメッセージを入力し、「変更を確定」を押下
8. 右上の「レビューを作成」を押下し、開発は完了。レビューと修正を行う

※ブランチ名が正しければgit側からも変更をpushできる。リリースする資材はGithubを参照するためこの方法が実現できる

## SalesforceのUI外で開発するケース

1. DevOps Center > 作業項目 > 新しい作業項目
2. 作業内容を入力（Github IssuesのURLを貼る、でもよい）
3. ブランチが発行される。ベースブランチは作業ブランチの上流ブランチである。
4. 3と同じブランチ名を持つローカルブランチを、リモートブランチから作成して開発
5. 変更をコミット・プッシュ
6. 「変更を確定」を押下

## レビュー

※ここではgithub上でマージしないこと

1. 対象の作業内容の「変更内容を表示」を押下すると、GithubのPRへリダイレクトするため、レビューする
2. レビュイは、レビューで修正指摘があれば、に沿って修正する。アドミであれば、「SalesforceのUI上でローコード開発するケース」の5~6を繰り返し、プログラマであれば修正した資材をpushする
3. レビュー終了後、「昇格準備完了」を押下してレビューを終了(一回ONにすると後戻りができないので、必ず全ての確認を行ってからスイッチをONにした方が無難)

↓

確認漏れでスイッチONしてしまった場合、一番右の上の「🔽」のボタンをクリックし、「状況をなしに変更...」ボタン押下で、作業項目自体を無しにすルコとが可能。しかしこちらの処理を行ったら、一から作業項目を作成する必要がある。

## 昇格(リリース)

1. DevOps Center > パイプライン
2. 昇格したい作業項目を選択して「選択したものを昇格」、本番への場合は「作業項目バンドルとして昇格」を押下
3. 昇格オプションでは、「昇格する変更」と「テストオプション」を選択可能。必要な方を選択して「昇格」を押下
4. 昇格に成功すると、PRが自動でマージされる。昇格に失敗するとエラーメッセージが出力されるため、新しく作業項目を作成して追加開発・修正を実施する

## 留意点

注意事項として知っておくべきことを記載する

- レビュー後、「昇格準備完了」の操作をして昇格作業ができるのは、DevOps Centerのみなので、PRのマージは「DevOps Center」に委任したほうがよい。上流環境へ昇格成功と同時にPRがベースブランチにマージされる特性があるため
- DevOps Centerの「作業項目」は、一度作成すると削除してUI上から無くすことができない。しかし、Github上では作成された作業ブランチはクローズされるためゴミブランチが残ることはない
- メタデータのみリリース対象である。docsなどメタデータ以外をgithub管理したい場合は、プログラマがDevOps Center発行ブランチに混ぜるか、DevOps Centerと無関係なブランチを発行してマージする
- DevOps Centerが発行するブランチ名は指定できず、`WI-000001`という名前になる。つまり、ブランチに意味を持たせることはできず、ブランチ名から作業内容を把握するようなことは期待しないほうがいい
- 「変更を確定」を押下して自動作成されるPRのタイトルも自動生成され、`[DevOps Center] WI-000001 を ブランチ名 にマージ`という名前になる
  - この`ブランチ名`には、パイプライン上の上流環境に指定したブランチ名となる
  - タイトルから編集内容がわからなくなるため、必要であれば手動で修正したほうがいい。Descriptionの編集、タグ付け、Reviewerの設定は手動で設定可能
- DevOps Centerが作成したブランチを使ってPRを手動で作成しても、DevOps Centerコンソールの「昇格準備完了」のタブは活性化する。つまり、PRはDevOps Centerからでも手動でもどちらから作っても構わない
- パイプラインについて
  - 最下流環境(つまり開発環境)は、環境の追加、変更が容易である
  - 中流環境(UAT環境など)は一度決定すると、変更が効きずらい。どうしても変更する場合、`すべての Sandbox を本番/リリース環境から更新するか、下流のパイプラインフェーズからコピーすることをお勧めします。`。という注意書きに従って変更する必要がある。
  - 各環境の昇格先環境が厳格に決まっている。以下のようなパイプラインを組んでいる場合、UIT環境(Partial Sandbox)にリリースする前にFullSandbox環境に載せてUATをしたい、という顧客の謎めいたオーダーには基本的に答えられない。メタデータAPIで個別にFullSandboxへリリースするほかないが、他環境との差分の正しさに疑問が残る
    - 開発環境 > CLのUT環境 > UAT環境 > 本番環境
    - それとは別に、本番をコピーしたFullSandbox環境
- ソース管理可能なレポジトリはGithubとBitBucketのみ
  - [DevOpsセンターで使用できるソース管理リポジトリ](https://help.salesforce.com/s/articleView?id=platform.devops_center_setup.htm&type=5)

## 課題点

- パイプラインの操作、上流環境への変更内容の昇格作業、つまりリリース作業は、**本番環境**での作業となる
  - 便利な仕組みであるのは確かだが、顧客のポリシー的にアウトなケースが多いと思われる。リリース関連は、顧客のリリースチームに任せきる、というのも手段の一つ
  - 作業者単位の本番アカウントが必要(後述する、DevOps Center用の権限セットで、開発・リリース権限を厳格化するなら尚更)
