# DevOpsCenterの運用について

このレポジトリでは、SalesforceのCI/CDとして運用可能なDevOpsCenterに関する練習を記録する。

## 背景

この練習をやろうと考えたのには、以下のような背景がある
- ローコード開発者(以下、アドミ)の思い
  - アドミは、リリース作業を変更セットに頼らざるを得ない（CLIに不慣れ）
  - 変更セットの作成はブラウザが重くなり、リリースまでに必要な作業時間が増えがち
  - プログラマに片寄するためだけに、CLIやGit、Githubを覚えるのがつらい
- プログラマの思い
  - メタデータはgithubで管理したい
  - 変更セットを使いたくない
  - メタデータAPIをつかったリリースに頼りたいが、手動コマンド入力で本番にリリースするのは心理的な負担がある
  - メタデータAPIのデプロイは、間違った環境へのリリースする危険が伴う
- 共通の思い
  - 最新のソースがなんなのか、把握できない（本番が正しいが、利用しているSandboxが最新なのか判断がしにくい）
  - 設定値をexcelなどドキュメントに設計書として記載して、SF組織上で正しい値になっているのか、試験で確認するのが億劫（というか馬鹿馬鹿しくなってやってられない）

↓

以上のことから、アドミ側とプログラマ側にはギャップがあり、達成したい共通の目標もあることは確か。
無料で利用できるDevOpsCenterでCICDには、以下の利点があることがわかった。
- アドミには、なるべくGithubに対する学習コストを抑えられる
- 変更セットから脱却
- ソースコード管理可能
- プログラマは今まで通り、メタデータAPIを利用可能
- 無料で利用可能

そのため、軽くGUI開発とプログラム開発を実践してみて、実際のPJ導入イメージを作りたい。

## バージョン管理の前提

- × 全てのメタデータを管理する
- ⚪︎ デフォルト状態で作成した組織に対して、追加・変更されたメタデータのみ管理する

↓

ありとあらゆるメタデータを管理したい気持ちもあるが、ベストプラクティスは差分のみの管理を行う

## パイプライン構築

設定、開発の進め方は以下の記事がとても参考になった。
- [Salesforce DevOps Centerについてまとめてみた](https://qiita.com/arufian/items/675a61af6c765d1977db)


設定は要約すると以下となる。
1. DevOpsCenterの有効化
2. DevOpsCenterパッケージインストール
3. 接続アプリケーションでDevOpsCenterを設定
4. 権限セットを開発・リリースユーザーに割り当てる
5. アプリケーションを開き、Github組織と接続
6. Salesforce上でプロジェクト作成（このとき、既存のレポジトリか新規レポジトリか選択できる。完全新規PJであれば新規レポジトリで良いと考える）
7. リリース先となる環境（本番、ステージングなど）の環境を、パイプラインに指定

### 権限セット

DevOpsCenterに必要な権限セット一覧。自動で組織にインストールされる

| 権限セット名                       | 説明                                                                                                                                                                                           | 割り当て先                                                                                                                       |
| ---------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------- |
| DevOps Center                      | DevOps Center の基本権限セット。作業項目のカスタマイズ管理に必要なデータアクセスと権限を提供。接続されているすべての環境とパイプラインを表示できる。                                           | すべての DevOps Center ユーザ、DevOps Center マネージャや権限セットを割り当てられたチームメンバー。2つの権限セットは重複しない。 |
| DevOps Center マネージャ           | DevOps Center のプロジェクト、環境、ユーザの設定に必要なデータアクセスおよび権限を提供。                                                                                                       | チームのマネージャ / プロジェクトマネージャ                                                                                      |
| DevOps Center リリースマネージャ   | パイプライン経由で昇格を行う権限を提供。                                                                                                                                                       | リリースマネージャ、およびパイプライン経由で変更を昇格するチームメンバー                                                         |
| sf\_devops\_InitializeEnvironments | DevOps Center プロジェクトのマネージャが作業環境への接続を管理できるようにする。メタデータ API を使った変更やアプリケーションのカスタマイズ権限も含まれ、Named Credential レコード作成が可能。 | チームのマネージャ / プロジェクトマネージャ                                                                                      |
| sf\_devops\_NamedCredentials       | 環境への認証に必要な指定ログイン情報へのアクセス権を付与。DevOps Center で自動的に作成および管理される。                                                                                       | すべての DevOps Center ユーザ                                                                                                    |


# パイプライン構築後

実際の開発手順は以下となる。組織を日本語設定しているため、案内は全て日本語である前提

## SalesforceのUI上でローコード開発するケース

1. DevOpsCenter > 作業項目 > 新しい作業項目
2. 作業内容を入力（Github IssuesのURLを貼る、でもよい）
3. 「接続された開発環境を使用して、DevOps Center から開発を行い、作業項目の機能ブランチへの変更を確定したいと考えています。」を選択し、自分の開発組織を選択し、「続行」をクリック。（自分の開発組織がなければ、「パイプライン > 環境」で、「開発環境を追加」をクリックして追加すること（追加権限がなければ、権限持ちユーザーに選択してもらう）
4. ブランチが発行される。ベースブランチは作業ブランチの上流ブランチである。
5. 開発環境でフローやカスタムオブジェクト、カスタム項目などを開発
6. 「変更を取り込み」もしくは「コンポーネントを手動で追加」を選択し、上流環境へ同期したいメタデータを選択リストから選択
7. コメント欄に、コミットメッセージを入力し、「変更を確定」を押下
8. 右上の「レビューを作成」を押下し、開発は完了。レビューと修正を行う


## SalesforceのUI外で開発するケース

1. DevOpsCenter > 作業項目 > 新しい作業項目
2. 作業内容を入力（Github IssuesのURLを貼る、でもよい）
3. ブランチが発行される。ベースブランチは作業ブランチの上流ブランチである。
4. 3と同じブランチ名を持つローカルブランチを、リモートブランチから作成して開発
5. コミット・プッシュ
6. 「変更を確定」を押下

## レビュー

※ここではgithub上でマージしないこと

1. 対象の作業内容の「変更内容を表示」を押下すると、GithubのPRへリダイレクトするため、レビューする
2. レビュイは、レビューで修正指摘があれば、に沿って修正する。アドミであれば、「SalesforceのUI上でローコード開発するケース」の5~6を繰り返し、プログラマであれば修正した資材をpushする
3. レビュー終了後、「昇格準備完了」を押下してレビューを終了(一回ONにすると後戻りができないので、必ず全ての確認を行ってからスイッチをONにした方が無難)

↓

確認漏れでスイッチONしてしまった場合、一番右の上の「🔽」のボタンをクリックし、「状況をなしに変更...」ボタン押下で、作業項目自体を無しにすルコとが可能。しかしこちらの処理を行ったら、一から作業項目を作成する必要がある。

## 昇格(リリース)

1. DevOpsCenter > パイプライン
2. 昇格したい作業項目を選択して「選択したものを昇格」、本番への場合は「作業項目バンドルとして昇格」を押下
3. 昇格オプションでは、「昇格する変更」と「テストオプション」を選択可能。必要な方を選択して「昇格」を押下
4. 昇格に成功すると、PRが自動でマージされる。昇格に失敗するとエラーメッセージが出力されるため、新しく作業項目を作成して追加開発・修正を実施する

## 留意点

課題とまではいかないが、注意事項として知っておくべきことを記載する

- レビューで、昇格準備完了ができるのは、「DevOpsCneter」
- 現状、作業項目は、一度作成すると削除してUI上から無くすことができない。Github上では作成された作業ブランチはクローズされるため、ゴミブランチ
- リリース可能なのはメタデータのみである。docsなどメタデータ以外をgithub管理したければ、プログラマがブランチに混ぜるしかない
- 作業ブランチ名は指定できず、CI/CDパイプラインに載せるにはDevOpsCenterが自動生成するブランチ名（e.g. `WI-000001`）を活用する必要がある。つまり、ブランチに意味を持たせることはできず、ブランチ名から作業内容を把握することは困難になる
- 常に`Create a marge commit`でマージされる。ブランチ戦略がある場合は融通が効かない可能性がある
- パイプラインについて
  - 最下流環境は、環境の追加、変更が容易である
  - 中流環境(UAT環境など)は一度決定すると、変更が効きずらい。どうしても変更する場合、`すべての Sandbox を本番/リリース環境から更新するか、下流のパイプラインフェーズからコピーすることをお勧めします。`。という注意書きに従って変更する必要がある。
  - 各環境の昇格先環境が厳格に決まっている。以下のようなパイプラインを組んでいる場合、UIT環境(Partial Sandbox)にリリースする前にFullsand環境に載せてUATをしたい、という顧客の謎めいたオーダーには基本的に答えられない。メタデータAPIで個別にFullsandへリリースするほかないが、他環境との差分の正しさに疑問が残る
    - 開発環境 > CLのUT環境 > UAT環境 > 本番環境
    - それとは別に、本番をコピーしたFullsand環境


## 課題点

パイプラインの操作、上流環境への変更内容の昇格作業、つまりリリース作業は、**本番環境**での作業となる
- 便利な仕組みであるのは確かだが、顧客のポリシー的にアウトなケースが多いと思われる。リリース関連は、顧客のリリースチームに任せきる、というのも手段の一つ
- 作業者単位の本番アカウントが必要(後述する、DevOpsCenter用の権限セットで、開発・リリース権限を厳格化するなら尚更)
- DevOpsCenterをインストールすると、５種類の権限セットが自動で用意される。作業い
